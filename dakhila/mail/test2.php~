<?php
require("phpmailer/class.phpmailer.php");
require 'db.inc';


  return $body;

}

function CreateDatabaseQuery() {
  $query = <<< DATABASE_QUERY_UMESH

SELECT Students2003.LAST_NAME, Students2003.FIRST_NAME, LanguageGrades.Description as ldes, 
       LanguageGrades.Room as lroom,  CultureGrades.Description as cdes, CultureGrades.Room as croom,
       LanguageGrades.Teachers as lteacher, CultureGrades.Teachers as cteacher,
       Parents2003.M_EMAIL as memail, Parents2003.F_EMAIL as femail
FROM ((
 (
  (
   (Students2003 INNER JOIN Parents2003 ON Students2003.PARENT_ID=Parents2003.ID) 
    INNER JOIN LanguageGrades ON Students2003.SS_LANG_NEXT=LanguageGrades.ID)  

  INNER JOIN CultureGrades ON Students2003.SS_CULT_NEXT=CultureGrades.ID) 
  INNER JOIN SchoolGrade ON Students2003.NEXT_YEAR_GRADE=SchoolGrade.ID) 
  INNER JOIN Email_Preferences ON Parents2003.PRIMARY_EMAIL_FLAG=Email_Preferences.ID) 
  INNER JOIN MusicGrades ON Students2003.SS_MUSIC_NEXT=MusicGrades.ID 


WHERE (((Students2003.CONTINUING)<>2) 
      And ((Students2003.STATUS) Is Null 
      Or (Students2003.STATUS)<>3)) 
      Or (((Students2003.STATUS)=1)) 
ORDER BY Students2003.LAST_NAME, Students2003.FIRST_NAME, SchoolGrade.Description; 
DATABASE_QUERY_UMESH;
  return $query;
}

function SendPhpMail($name,  $sendToArray, $body) {
  $mail = new PHPMailer(false); 
  $mail->IsSMTP(); // send via SMTP
  //IsSMTP(); // send via SMTP
  $mail->SMTPAuth = true; // turn on SMTP authentication
  $mail->Username = "announcement@vidyalaya.us"; // SMTP username
  $mail->Password = "praveen"; // SMTP password
  $webmaster_email = "umesh@vidyalaya.us"; //Reply to this email ID
  $mail->From = $webmaster_email;
  $mail->FromName = "Vidyalaya Announcement";

  foreach ($sendToArray as $value) {
    if ("" != $value) {
      echo "DEBUG: Adding email address for $name -  $value \n";
      $mail->AddAddress($value,$value);
    }
  }

  $mail->AddReplyTo("info@vidyalaya.us","Vidyalaya Information");
  $mail->WordWrap = 50; // set word wrap

  //  $mail->AddAttachment("/home/umesh/Vidyalaya-0918.pdf"); // attachment
  //  $mail->AddAttachment("/home/umesh/eastlakelayout2010.pdf"); // attachment

  $mail->IsHTML(true); // send as HTML

  $mail->Subject = "Vidylaya: Class Assignment and Opening Day";


  $mail->Body = $body;
  $mail->AltBody = "This is the body when user views in plain text format"; //Text Body
  if(!$mail->Send()) 	 {
    echo "Mailer Error sending mail for $name: " . $mail->ErrorInfo . "\n";  return; 
  }

  echo "Message has been sent for $name ".  implode(", ", $sendToArray). "\n";
}


function main ($connection) {


  $query = CreateDatabaseQuery();
  if (!($result = mysql_query($query, $connection)))
    showerror();
  $i=0;

  while ($row = mysql_fetch_assoc($result)) {
    $i++;
    $name = $row["FIRST_NAME"] . " " .  $row["LAST_NAME"];
    $lroom=$row["lroom"]; $croom=$row["croom"];
    $lang = $row["ldes"];
    $cult = $row["cdes"];
    $memail = $row["memail"]; $femail = $row["femail"];
    $lteacher = $row["lteacher"]; $cteacher = $row["cteacher"];
    $sendToArray = array_merge(explode(";", $row["memail"]), explode(";", $row["femail"]));
#    $sendToArray = array("umesh@vidyalaya.us");
#    $sendToArray = array("umesh@qvt.com");



    $body = CreateBody($name, $lang, $cult, $sendToArray, $lteacher, $cteacher, $lroom, $croom);

    //   id we are testing are 249 ankita, 142 kevin 131 prachi
    //      if (strpos($memail, ",") || strpos($femail, "," )) {
#    if ($i == 141) {
      echo "\n" . "$i, $name, $lang, $cult,".  implode(", ", $sendToArray). "\n";
#      SendPhpMail($name, $sendToArray,  $body);
#    }
  }
}

  if (!$connection = @ mysql_connect($hostname, $username, $password))
    die("Cannot connect using hostname=$hostname, user=$username, password=$password\n");
  if (!mysql_selectdb($databasename, $connection))
    showerror();
  session_start();


main($connection);


?>